[tox]
envlist = py39, py310, py311, py312, py313,lint
isolated_build = true

[testenv]
deps =
    pytest
    pytest-cov
    gunicorn
    redis>=4.0.0
    eventlet>=0.33.0
    gevent>=23.0.0
    tornado>=6.0.0
commands =
    pytest tests/ --cov=gunicorn_prometheus_exporter \
        --cov-report=xml:{toxinidir}/coverage.xml {posargs}

[testenv:lint]
description = Run linters and code quality tools
deps =
    ruff
    xenon
    prospector
    radon
    bandit
allowlist_externals = bash
commands =
    # Formatting and basic linting
    ruff check src tests
    ruff format --check src tests

    # Code complexity analysis
    xenon src --max-absolute B --max-modules A --max-average A

    # Code quality analysis
    prospector src --without-tool dodgy

    # Cyclomatic complexity
    bash -c "radon cc src -a || echo 'Radon CC scan completed'"

    # Maintainability index
    bash -c "radon mi src || echo 'Radon MI scan completed'"

    # Security analysis
    bandit -r src
